\setlength{\abovecaptionskip}{0pt plus 3pt minus 2pt}
\setlength{\belowcaptionskip}{0pt plus 3pt minus 2pt}

\abovedisplayskip1mm
\belowdisplayskip1mm
\abovedisplayshortskip1mm
\belowdisplayshortskip1mm

\setlength{\topsep}{5pt}
\setlength{\partopsep}{5pt plus 0pt minus 0pt}
\setlength{\parskip}{5pt}
\setlength{\parindent}{10pt}

\clearpage
\section{Proofs}
\label{sec:proofs_appendix}

\begin{lemma}
\label{lem:theta_constant}
Let $C_f$ and $C_g$ be real positive constants. If

\[ h\,(x) = f\,(x) + C_f + \Theta\,(g\,(x) + C_g) \]

and value $g\,(x)$ is positive for arbitrary $x$ then

\[ h\,(x) = f\,(x) + \Theta\,(g\,(x)) \]

\end{lemma}
\begin{proof}
\begin{enumerate}
\item For some real postive $C_1$: $h\,(x) \ge f\,(x) + C_f + C_1 \cdot (g\,(x) + C_g)$, thus $h\,(x) \ge f\,(x) + C_1 \cdot g\,(x)$
\item For some real postive $C_2$: $h\,(x) \le f\,(x) + C_f + C_2 \cdot (g\,(x) + C_g)$, thus $h\,(x) \ge f\,(x) + (C_f + C_2 + C_2 \cdot C_g) \cdot g\,(x)$
\qed
\end{enumerate}
\end{proof}

\begin{lemma}
\label{lem:theta_sum}
If

\[ h_1\,(x) = f_1\,(x) + \Theta\,(g_1\,(x)) \]

and

\[ h_2\,(x) = f_2\,(x) + \Theta\,(g_2\,(x)) \]

then

\[ (h_1\,(x) + h_2\,(x)) = (f_1\,(x) + f_2\,(x)) + \Theta\,(g_1\,(x) + g_2\,(x)) \]

\end{lemma}
\begin{proof}
Both lower- and upper-bound constants are the sums of the two corresponding constants for the given approximations.
\qed
\end{proof}

\begin{lemma}
\label{lem:theta_absorb}
Let $g_1\,(x) \ge g_2\,(x) > 0$ for all $x$. If

\[ h\,(x) = f\,(x) + \Theta\,(g_1\,(x) + g_2\,(x)) \]

then

\[ h\,(x) = f\,(x) + \Theta\,(g_1\,(x)) \]

\end{lemma}
\begin{proof}
\begin{enumerate}
\item For some real  postive $C_1$: \[ h\,(x) \ge f\,(x) + C_1 \cdot (g_1\,(x) + g_2\,(x)) \ge f\,(x) + C_1 \cdot g_1\,(x) \]
\item For some real  postive $C_2$: \[ h\,(x) \le f\,(x) + C_2 \cdot (g_1\,(x) + g_2\,(x)) \le f\,(x) + 2 C_2 \cdot g_1\,(x) \]
\qed
\end{enumerate}
\end{proof}

\begin{lemma}
\label{lem:task_measure_equations}
  If

  \[\taskst{g}{e} \xrightarrow{l} s^\prime\]

  then

  \[
    \begin{array}{rcl}
    d\,(\taskst{g}{e}) &=& d\,(s^\prime) + 1\\
    t\,(\taskst{g}{e}) &=& t\,(s^\prime) + 1
    \end{array}
  \]
\end{lemma}
\begin{proof}
    Immediately from the definitions of the estimated values.
    \qed
\end{proof}


\repeatlemma{lem:sum_measure_equations}
\begin{proof}
Induction on the sum of values $d\,(s_1) + d\,(s_2)$. Both equations easily hold for both the rules \ruleno{DisjStop} and \ruleno{DisjStep} if we apply
the inductive hypothesis for the next state.
\qed
\end{proof}

\repeatlemma{lem:times_measure_equations}
\begin{proof}
Induction on the value $d\,(s \times g)$. Both equations easily hold for all the rules \ruleno{ConjStop}, \ruleno{ConjStopAns}, \ruleno{ConjStep}, \ruleno{ConjStepAns}
if we apply the inductive hypothesis for the next state.
\qed
\end{proof}

\repeatlemma{lem:otimes_t_approximation}
\begin{proof}
After unfolding the defintions and throwing out the identical parts we have the following statement:

\[ \begin{array}{l}
d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} \min\,\{2\cdot d\,(\taskst{g}{a_i}) - 1, 2\cdot d\,(s'_i \otimes g)\}  = \\
= \Theta\,(d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i}) - \smashoperator{\maxd\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i})) \\
\end{array} \]

If $\tra{s}$ is empty, the statement is trivial.

If $\tra{s}$ is not empty, $\displaystyle{\maxd}$ turns into a simple $\max$. We establish lower and upper bounds separately.

\begin{enumerate}
  \item
  Lower bound. Let's show that 
  
  \[ \begin{array}{l}
  d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} \min\,\{2\cdot d\,(\taskst{g}{a_i}) - 1, 2\cdot d\,(s'_i \otimes g)\}  \ge \\
  \ge d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i}) - \smashoperator{\max\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i}) \\
  \end{array} \]

  First, we can decrease both arguments of $\min$:

  \[ \begin{array}{l}
  d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} \min\,\{2\cdot d\,(\taskst{g}{a_i}) - 1, 2\cdot d\,(s'_i \otimes g)\}  \ge \\
  \ge d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} \min\,\{ d\,(\taskst{g}{a_i}), d\,(s'_i \otimes g)\} \\
  \end{array} \]

  Let's consider two cases.

  \begin{enumerate}
    \item The minimum in this expression is always reached on the first argument. Then
    
    \[ \begin{array}{l}
        d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} \min\,\{ d\,(\taskst{g}{a_i}), d\,(s'_i \otimes g)\} = \\
        = d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i}) \ge \\
        \ge d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i}) - \smashoperator{\max\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i}) \\
  \end{array} \]
  
    \item $a_m$ is the first answer, such that the minimum for $a_m$ is reached on the second argument. Then the answers up to $a_m$ are sufficient to prove the bound. 
    
    \[ \begin{array}{l}
        d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} \min\,\{ d\,(\taskst{g}{a_i}), d\,(s'_i \otimes g)\} \ge \\
        \ge d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \{ a_1, \dots, a_m \}}} \min\,\{ d\,(\taskst{g}{a_i}), d\,(s'_i \otimes g)\} = \\
        = d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \{ a_1, \dots, a_{m - 1} \}}} d\,(\taskst{g}{a_i}) + d\,(s'_m \otimes g) = \\
        = d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \{ a_1, \dots, a_{m - 1} \}}} d\,(\taskst{g}{a_i}) + d\,(s'_m) + \smashoperator[lr]{\sum\limits_{a_i \in (\tra{s} \setminus \{ a_{1}, \dots, a_{m} \})}} d\,(\taskst{g}{a_i})  \ge \\
        \ge d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i}) -  d\,(\taskst{g}{a_m}) \ge \\
        \ge d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i}) -  \smashoperator{\max\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i}) \\
  \end{array} \]
  \end{enumerate}

  \item 
  Upper bound. Let's show that 
  
  \[ \begin{array}{l}
  d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} \min\,\{2\cdot d\,(\taskst{g}{a_i}) - 1, 2\cdot d\,(s'_i \otimes g)\}  \le \\
  \le 4 \cdot (d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i}) - \smashoperator{\max\limits_{a_i \in \tra{s}}} d\,(\taskst{g}{a_i})) \\
  \end{array} \]
  
  For the upper bound we replace every $\min$ with any of its arguments (the result can only increase). Let $a_m = \argmax{a_i \in \tra{s}} d\,(\taskst{g}{a_i})$. Then for the upper bound let's
  go with the second argument of $\min$ for $a_m$ and with the first argument for all others.
  
   \[ \begin{array}{l}
  d\,(s) + \smashoperator[lr]{\sum\limits_{a_i \in \tra{s}}} \min\,\{2\cdot d\,(\taskst{g}{a_i}) - 1, 2\cdot d\,(s'_i \otimes g)\}  \le \\
  \le d\,(s) + 2 \cdot d\,(s'_m \otimes g) + \smashoperator[lr]{\sum\limits_{a_i \in (\tra{s} \setminus \{a_m\})}} (2\cdot d\,(\taskst{g}{a_i})) \le \\
  \le d\,(s) + 2 \cdot d\,(s'_m) + 2\cdot\smashoperator[lr]{\sum\limits_{a_i \in (\begin{array}{l} \tra{s} \setminus \\ \{a_1, \dots, a_m\}) \end{array}}} d\,(\taskst{g}{a_i}) + 2\cdot\smashoperator[lr]{\sum\limits_{a_i \in (\tra{s} \setminus \{a_m\})}} d\,(\taskst{g}{a_i}) \le \\
  \le d\,(s) + 2 \cdot d\,(s) + 2\cdot\smashoperator[lr]{\sum\limits_{a_i \in (\tra{s} \setminus \{a_m\})}} d\,(\taskst{g}{a_i}) + 2\cdot\smashoperator[lr]{\sum\limits_{a_i \in (\tra{s} \setminus \{a_m\})}} d\,(\taskst{g}{a_i}) \le \\
  \le 4 \cdot d\,(s) + 4\cdot\smashoperator[lr]{\sum\limits_{a_i \in (\tra{s} \setminus \{a_m\})}} d\,(\taskst{g}{a_i}) \\
  \end{array} \] $\qed$

\end{enumerate}

\end{proof}

\begin{lemma}
\label{lem:times_gen_measure_approximations}

Let $s = ((s_0 \otimes g_1) \dots \otimes g_k)$ and let $A_i$ be a set of all answers that are passed to $g_i$, i.e.

\[
\begin{array}{rcl}
A_1 &=& \tra{s_0} \\
A_{i + 1} & = & \bigcup\limits_{a \in A_i} \tra{\taskst{g_i}{a}} 
\end{array}
\]

Then

\[
\begin{array}{rcrl}
d\,(s) &=& & d\,(s_0) + \sum\limits_{1 \le i \le k} \displaystyle\sum\limits_{a \in A_i} d\,(\taskst{g_i}{a}) \\
\\
t\,(s) &=& & t\,(s_0) + \sum\limits_{1 \le i \le k} \displaystyle\sum\limits_{a \in A_i} t\,(\taskst{g_i}{a}) + \\
& & + \Theta\,(& d\,(s_0) + \sum\limits_{1 \le i \le k} \displaystyle\sum\limits_{a \in A_i} d\,(\taskst{g_i}{a}) - \maxd\limits_{a \in A_k}  d\,(\taskst{g_k}{a})) \\
\end{array}
\]

\end{lemma}
\begin{proof}
First we show that for all $i$, $A_{i + 1} = \tra{((s_0 \otimes g_1) \dots \otimes g_i)}$ (it's a simple induction on $i$ and then on the trace).

Then we can prove the statement by induction on $k$.
We unfold $d\,(s \otimes g_{k+1})$ and $t\,(s \otimes g_{k+1})$ using equations in \lemmaword~\ref{lem:times_measure_equations}.
Then we rewrite $d\,(s)$ and $t\,(s)$ in these equations with inductive hypothesis.
For $d\,(s \otimes g_{k+1})$ we get exactly the equation we need.
For $t\,(s \otimes g_{k+1})$ we have a sum of the following parts (first two from the unfolding of $t\,(s)$, last two from the rest of the equation for $t\,(s \otimes g_{k+1})$):
\begin{enumerate}
\item $t\,(s_0) + \displaystyle{\sum\limits_{1 \le i \le k}} \displaystyle\sum\limits_{a \in A_i} t\,(\taskst{g_i}{a})$
\item $ \Theta\,(d\,(s_0) +  \displaystyle{\sum\limits_{1 \le i \le k}} \displaystyle\sum\limits_{a \in A_i} d\,(\taskst{g_i}{a}) - \maxd\limits_{a \in A_k}  d\,(\taskst{g_k}{a}))$
\item $\displaystyle\sum\limits_{a \in A_{k+1}} t\,(\taskst{g_{k+1}}{a})$
\item $ \Theta\,(d\,(s_0) +  \displaystyle{\sum\limits_{1 \le i \le k}} \displaystyle\sum\limits_{a \in A_i} d\,(\taskst{g_i}{a}) + \displaystyle\sum\limits_{a \in A_k} d\,(\taskst{g_{k+1}}{a}) - \maxd\limits_{a \in A_{k + 1}}  d\,(\taskst{g_k}{a}))$
\end{enumerate}

We can see that the second part is subsumed by the last part (by \lemmaword~\ref{lem:theta_absorb}). The rest gives exactly the equation we need.
\qed
\end{proof}

Here is the general definition of well-formedness of states from~\cite{CertifiedSemantics}.

\begin{definition}
  Well-formedness condition for extended states:

  \begin{itemize}
  \item $\diamond$ is well-formed;
  \item $\inbr{g, \sigma, n}$ is well-formed iff $\fv{g}\cup\Dom\,(\sigma)\cup\VRan\,(\sigma)\subseteq\{\alpha_1,\dots,\alpha_n\}$;
  \item $s_1\oplus s_2$ is well-formed iff $s_1$ and $s_2$ are well-formed;
  \item $s\otimes g$ is well-formed iff $s$ is well-formed and for all leaf triplets $\inbr{\_,\_,n}$ in $s$ it is true that $\fv{g}\subseteq\{\alpha_1,\dots,\alpha_n\}$.
  \end{itemize}

\end{definition}

We will need \lemmaword~\ref{lem:measures_changing_env} in the following generalized form.

\begin{lemma}
\label{lem:gen_measures_changing_env}
Let $\pi \colon \{ \alpha_1, \dots, \alpha_N \} \to \{ \alpha_1, \dots, \alpha_{N'} \}$ be an injective function on variables and let $R_{\pi}$ be the following inductively defined relation on states:
\[ \begin{array}{lcl}
\Diamond R_{\pi} \Diamond & & \\
\taskst{g}{\mkenv{\sigma}{n}} R_{\pi} \taskst{g'}{\mkenv{\sigma'}{n'}} & \textit{iff} & g \sigma \pi = g' \sigma' \\
(s_1 \oplus s_2) R_{\pi} (s'_1 \oplus s'_2) & \textit{iff} & s_1 R_{\pi} s'_1 \land s_2 R_{\pi} s'_2  \\
(s \otimes g) R_{\pi} (s' \otimes g') & \textit{iff} & s R_{\pi} s' \land \\
\multicolumn{3}{l}{\textit{\quad for all substates $\taskst{g_i}{\mkenv{\sigma_i}{n_i}}$ in $s$}}\\
\multicolumn{3}{l}{\textit{\quad and corresponding substates $\taskst{g'_i}{\mkenv{\sigma'_i}{n'_i}}$ in $s'$,}} \\
\multicolumn{3}{l}{\quad g \sigma_i \pi = g' \sigma'_i} \\
\end{array} \]

Then for any two well-formed states $s$ and $s'$, such that all counters occuring in $s$ are less or equal than some $n$ and all counters occuring in $s'$ are less or equal than some $n'$ and $s R_{\pi} s'$ for some injective function $\pi \colon \{ \alpha_1, \dots, \alpha_n \} \to \{ \alpha_1, \dots, \alpha_n' \}$,

\[ d\,(s) = d\,(s') \]
and

\[t\,(s) = t\,(s') \]

and there is a bijection $b$ between sets of answers $\tra{s}$ and $\tra{s'}$ such that for any answer $a = \mkenv{\sigma_r}{n_r} \in \tra{s}$ there is a corresponding answer $b(a) = \mkenv{\sigma'_r}{n'_r} \in \tra{s'}$, s.t. $\sigma_r = \sigma \delta$ for some $\sigma$ that is a subtitution in some leaf substate of $s$ and $\sigma'_r = \sigma' \delta'$ for $\sigma'$ that is the substitutution of the corresponding leaf substate of $s'$ and there is an injective function $\pi_r \colon \{ \alpha_1, \dots, \alpha_{n_r} \} \to \{ \alpha_1, \dots, \alpha_{n'_r} \}$ such that $\pi_r \succ \pi$ and $\pi \delta' = \delta \pi_r$.
\end{lemma}
\begin{proof}
We prove it by induction on the length of the trace for $s$; simultaneously we prove that the next states in the traces for $s$ and $s'$ also satisfy the relation $R_{\pi_r}$ for some $\pi_r$ (s.t. $\pi_r \succ \pi$). The equalities $d\,(s) = d\,(s')$ and $t\,(s) = t\,(s')$ are obvious in this induction, because states in the relation $R_{\pi}$ always have the same form (and therefore the same left height). To prove the fact about the bijection between answers and the fact that the relation holds for the next states we conduct an internal induction on the relation of operational semantics step. When we move through the introduction of the fresh variable we extend the injective function changing the variable by a binding between new fresh variables. In the base case of unification, when we extend the substitutions by the most general unifiers, we have the fact about the bijection between the sets of answers (singleton in this case) for the same injective renaming function by definition of the unification algorithm (we may change the names of variables before the unification and the result will be the same as if we do it after the unification):

\[ \pi \, mgu\,(t_1 \sigma \pi, t_2 \sigma \pi) = mgu\,(t_1 \sigma, t_2 \sigma) \, \pi  \]

For the case when we incorporate the answer obtained at this step in the next state (in rules $\ruleno{ConjStopAns}$ and $\ruleno{ConjStepAns}$) we use the statement about the bijection between the sets of answers from the inductive hypothesis to prove that the next states satisfy the relation:

\[ g \sigma \delta \pi_r = g \sigma \pi \delta' = g' \sigma' \delta'  \] 

All other cases naturally follow from inductive hypotheses.\qed

\end{proof}

\repeatlemma{lem:measures_changing_env}
\begin{proof}
It is a special case of \lemmaword~\ref{lem:gen_measures_changing_env}.\qed
\end{proof}

\begin{lemma}
\label{lem:update_substitutions_FV}

Let $\taskst{g_0}{\mkenv{\sigma_0}{n_0}}$ be a leaf state. Then for every answer $\mkenv{\sigma'}{n'}$ in $\tra{\taskst{g_0}{\mkenv{\sigma_0}{n_0}}}$, $\sigma' = \sigma_0 \delta$ for some substitution $\delta$, such that $\Dom\,(\delta) \cup \VRan\,(\delta) \subset FV\,(g_0 \sigma_0) \cup \{ \alpha_i \mid i > n_0 \}$.

\end{lemma}
\begin{proof}

First, we need some notions to generalize the statement.

Let $ENV\,(s)$ be the set of environments that occur in the given state.

\[ \begin{array}{lcl}
ENV\,(\Diamond) & = & \emptyset \\
ENV\,(\taskst{g}{e}) & = & \{ e \} \\
ENV\,(s_1 \oplus s_2) & = & ENV\,(s_1) \cup ENV\,(s_2) \\
ENV\,(s \otimes g) & = & ENV\,(s) 
\end{array} \]

Now, let's generalize the set of variables updated by answers from the statement to an arbitrary state.

\[ \begin{array}{lcl}
\Delta\,(\Diamond) & = & \emptyset \\
\Delta\,(\taskst{g}{\mkenv{\sigma}{n}}) & = & FV\,(g \sigma) \cup \{ \alpha_i \mid i > n \} \\
\Delta\,(s_1 \oplus s_2) & = & \Delta\,(s_1) \cup \Delta\,(s_2) \\
\Delta\,(s \otimes g) & = & \Delta\,(s_1) \cup \bigcup\limits_{\mkenv{\sigma}{n} \in ENV\,(s)} FV\,(g \sigma)
\end{array} \]

Now we can generalize the statement but for one semantical step only: if $s \xrightarrow{l} s'$, then the following three conditions hold:

\begin{enumerate}
\item $\Delta\,(s) \supset \Delta\,(s')$
\item If $l = \mkenv{\sigma'}{n'}$ then there exists $\mkenv{\sigma}{n} \in ENV\,(s)$ and substitution $\delta$, such that $\sigma' = \sigma \delta$ and $n' = n$ and $\Dom\,(\delta) \cup \VRan\,(\delta) \subset \Delta\,(s)$
\item For any $\mkenv{\sigma'}{n'} \in ENV\,(s')$ there exists $\mkenv{\sigma}{n} \in ENV\,(s)$ and substitution $\delta$, such that $\sigma' = \sigma \delta$ and $n' \ge n$ and $\Dom\,(\delta) \cup \VRan\,(\delta) \subset \Delta\,(s)$
\end{enumerate}

We prove it by the induction on semantical step relation (we have to prove all three conditions simultaneously).

\begin{enumerate}
\item The first condition is simple for the steps from leaf goals: the counters of occupied variables can only increase and the sets of free variables of subgoals can only decrease (except for the case of fresh variable introduction, where a new free variable appears, but it is greater than the counter); in case of invocation we use the fact that the body of any relation is closed (there are no free variables except for the arguments). For the $\ruleno{ConjStopAns}$ rule we use the second condition: the next step has the environment that updates one of the environments in $s$, so it does not introduce new variables in $\Delta$ and the counter also may only increase. For the $\ruleno{ConjStep}$ rule we use the third condition: all substitutions from environments of updated state after application to a goal do not introduce new variables in $\Delta$, the rest is handled by the inductive hypothesis. For the $\ruleno{ConjStepAns}$ rule we combine two previous arguments and for other cases the first condition is obvious from the inductive hypothesis.

\item The second condition needs to be proven only for the $\ruleno{UnifySuccess}$ rule (where it follows from the properties of the unification algorithm) and for the rules $\ruleno{DisjStop}$ and $\ruleno{DisjStep}$ (where it is obvious from the inductive hypothesis).

\item The third condition follows simply in all cases from the inductive hypothesis and from the second condition (for the rules $\ruleno{ConjStep}$ and $\ruleno{ConjStepAns}$ where the answer is incorporated in the next state).
\end{enumerate}

Now, the statement of the lemma follows from the generalized statement for one step: at each step substitutions in the answers and in the next step are composed with some additional substitutions that manipulate with only variables from the set $\Delta$ for this step, which is a subset of the set $\Delta$ in the beginning, which is exactly what we need.
\qed

\end{proof}

\repeatlemma{lem:symbolic_unification_soundness}
\begin{proof} $ $

From the corectness of the Robinson's unification algoithm we know that a substitution unifies the pair of terms $(t_1, t_2)$ iff it unifies all pairs of terms from the set $\{ (x, \delta\,(x)) \mid x \in \Dom\,(\delta) \}$ (because we obtain $\delta$ from the pair $(t_1, t_2)$ by Robinson's algorithm that maintains equivalent unification problem).

First, let's notice that similarly a substitution unifies the pair of terms $(t_1 \rho, t_2 \rho)$ iff it unifies all pairs of terms  $T = \{ (\rho\,(x), \delta\,(x) \rho) \mid x \in \Dom\,(\delta) \}$: $\nu$ is such substitution iff $\rho \nu$ unifies the terms $(t_1, t_2)$. And then also any most general unifier for $(t_1 \rho, t_2 \rho)$ is the most general unifier for $T$ and vice versa (by definition).

So now we need to show that $T$ is unifiable iff the unique $\rho'$ from the statement of the lemma exists (and that the most general unifier for $T$ can be defined with $\rho'$ and $\delta$). In both directions we will use the induction on the construction of the set of variables $U$, so lets consider the following sequence $U_i$: $U_0 = V$ and $U_{i+1} = \{ U_i \cup \bigcup\limits_{x \in U_{i}} FV\,(\delta\,(x)) \}$ (so $U$ is $U_l$ such that $U_l = U_{l + 1}$).

\begin{enumerate}
\item Suppose there is a substitution $\tau$ that unifies all the terms in $T$. Let's show that there is a unique $\rho'$ such that $\rho' \succ \rho$ and $\forall (y, \, t) \in \constr{\delta}{U}, \\ \rho'(y) = t \rho'$.

We know that $\rho\,(x) \tau = \delta\,(x) \rho \tau$ for all $x \in \Dom\,(\delta)$. We need the same condition for $\rho'$ for all $x \in U \cap \Dom\,(\delta)$. We can now show by induction on $i$ that for all variables $x \in U_i$ ($i \ge 1$) the value $\tau\,(x)$ is ground and uniquely defined for a given $\rho$, so they can be taken as values of $\rho'$ on variables from $U \setminus V$ and they are the only possible values. First, look at a pair $(\rho\,(x), \delta\,(x) \rho)$ in $T$ for some $x \in V$. We know that $\rho\,(x) \tau = \delta\,(x) \rho \tau$ and the term on the lhs is ground and uniquely defined by $\rho$. So the values of $\tau$ for all free variables of $\delta\,(x) \rho$ are ground and uniquely defined by $\rho$, too. If we do it for all such pairs in $T$ we will get the statement for $U_1$, then we can repeat this reasoning by induction for all $U_i$.

\item Now suppose there is $\rho'$ such that $\rho' \succ \rho$ and $\forall (y, \, t) \in \constr{\delta}{U}, \rho'(y) = t \rho'$. Let's construct the most general unifier for $T$ using the Robinson's algorithm.

Let's split $T$ on $T_U = \{ (\rho\,(x), \delta\,(x) \rho) \mid x \in U \cap \Dom\,(\delta) \}$ and $T_{-U} = \{ (\rho\,(x), \delta\,(x) \rho) \mid x \in  \Dom\,(\delta) \setminus U \}$. We will be applying rules from the Robinson's algorithm to $T$ for pairs of terms from $T_U$.

First, let's look at some pair $(\rho\,(x), \delta\,(x) \rho)$ for $x \in V \cap \Dom\,(\delta)$. By definition of $\rho'$ we have $\rho\,(x) \rho' = \delta\,(x) \rho \rho'$. The first term in the pair is ground, the second one may contain free variables (then they are variables from $U_1$). If the second term is ground, too, they are equal and we can delete this pair. Otherwise, using decomposition rule we decompose this pair to pairs of terms with second term being variable. After this, we will have pairs $(\rho'(y), y)$ for all $y \in FV\,(\delta\,(x) \rho)$. After that we do it for all such pairs for all variables from $V \cap \Dom\,(\delta)$, this pairs will turn into swapped bindings $(\rho'(y), y)$ for all $y \in U_1$ (maybe with repetitions). We then can discard the duplicates, swap the elements and apply this bindings in the rest of $T$. Now all the pairs $(\rho\,(x), \delta\,(x) \rho)$ for $x \in (U_1 \setminus V) \cap \Dom\,(\delta)$ after substitution have ground terms as the left term and we can repeat the transformation for all these pairs. We can repeat this process by induction on $i$ for $x \in U_i$, until $U_i$ becomes equal to $U$.

After this application of rules all pairs from $T_U$ are decomposed and turned into the substitution (as a set of bindings) $\rho'\restriction_{U \setminus V}$. On the other hand the pairs from $T_{-U}$  are not decomposed, just applied substitutions to them so every pair from this part still has some variable $z$ as the first term (because $z\not\in U$) and term $\delta\,(z) \rho (\rho'\restriction_{U \setminus V})$ as the second term. So we can see that we turned the set of terms $T$ into the substitution ${(\delta\restriction_{\Dom\,(\delta) \setminus U} \rho')\restriction_{\Dom\,(\delta) \setminus V}}$ which equals ${(\delta \rho')\restriction_{\Dom\,(\delta) \setminus V}}$ because $\rho'$ unifies bindings in $\delta$, so this substitution is the most general unifier for $T$ and therefore for terms $t_1 \rho$ and $t_2 \rho$. Then this substitution is alpha-equivalent to $mgu\,(t_1 \rho, t_2 \rho)$ (because most general unifiers are unique up to alpha-equivalence). So if we take $\rho mgu\,(t_1 \rho, t_2 \rho)$, we will get substitution alpha-equivalent to the substitution ${\rho ((\delta \rho')\restriction_{\Dom\,(\delta) \setminus V})}$ which equals to the substitution $\delta \rho'$ (obviously separately for variables from $V$ andfrom outside $V$).
\qed
 

\end{enumerate}
\end{proof}

\repeattheorem{extracted_approximations}
\begin{proof}
$ $\newline
\begin{enumerate}
\item Suppose we have proven this statement for $g \in C_{nf}$. Let's show it holds for $g \in D_{nf}$.
	\begin{enumerate}
	\item First, we prove it for  $g \in F_{nf}$ by induction on the goal.
	After unfolding each fresh constructor we get a goal with the same scheme.	
	Also going through each fresh constuct increases the values of $d\,(\cdot)$ and $t\,(\cdot)$ by $1$ by \lemmaword~\ref{lem:task_measure_equations}, this additional constant can be deleted by \lemmaword~\ref{lem:theta_constant}.
	
	\item Now we prove it for $g \in D_{nf}$ by induction on the goal. Let $g = \disjgoal{g_1}{g_2}$. Let $\schemewithvset{\mathfrak{S}_1}{V}$ be $\schemewithvset{\mathfrak{S}_2}{V}$ be children of the root in $\schemewithvset{\mathfrak{S}}{V}$.
		
	By \lemmaword~\ref{lem:task_measure_equations} and \lemmaword~\ref{lem:sum_measure_equations} and \lemmaword~\ref{lem:measures_changing_env} we have the following equations:

    \[ \begin{array}{lcl}
	d\,(\taskst{\disjgoal{g_1}{g_2}}{e_{init}}) &=& d\,(\taskst{g_1}{e_{init}}) + d\,(\taskst{g_2}{e_{init}}) + 1 \\
	\\
	t\,(\taskst{\disjgoal{g_1}{g_2}}{e_{init}}) &=& t\,(\taskst{g_1}{e_{init}}) + t\,(\taskst{g_2}{e_{init}}) \\
	&& + \min\,(2 d\,(\taskst{g_1}{e_{init}}) - 1, 2 d\,(\taskst{g_2}{e_{init}})) + 1
	\end{array} \]
	
	After rewriting the right part with inductive hypotheses (combining them using \lemmaword~\ref{lem:theta_constant} and \lemmaword~\ref{lem:theta_sum}) we get the following approximations.
	
	 \[ \begin{array}{lcl}
	d\,(\taskst{\disjgoal{g_1 \rho}{g_2 \rho}}{e_{init}}) &=& \mathcal{D}(\schemewithvset{\mathfrak{S}_1}{V})(\rho) + \mathcal{D}(\schemewithvset{\mathfrak{S}_2}{V})(\rho) + \Theta\,(1) \\
	\\
	t\,(\taskst{\disjgoal{g_1 \rho}{g_2 \rho}}{e_{init}}) &=& \mathcal{T}(\schemewithvset{\mathfrak{S}_1}{V})(\rho) + \mathcal{T}(\schemewithvset{\mathfrak{S}_2}{V})(\rho) + \\
	& & \Theta\,(\min\,(\mathcal{D}(\schemewithvset{\mathfrak{S}_1}{V})(\rho), \mathcal{D}(\schemewithvset{\mathfrak{S}_2}{V})(\rho)) + \\
	& & + (\mathcal{D}(\schemewithvset{\mathfrak{S}_1}{V})(\rho) - \smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_1}{V})(\rho)}} d\,(\taskst{g_i}{e_i})) + \\
	& & + (\mathcal{D}(\schemewithvset{\mathfrak{S}_2}{V})(\rho) - \smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_2}{V})(\rho)}} d\,(\taskst{g_i}{e_i})) + 1) \\
	\end{array} \]
	
	For $d\,(\cdot)$ it is exactly what we need. 
   
   	W.l.o.g. let's suppose the minimum in the approximation for $t\,(\cdot)$ is achieved at the first argument.
   
   	Let's consider two cases: which of $\smashoperator{\maxd\limits_{\taskst{g_i}{e_i}  \in \mathcal{L}(\schemewithvset{\mathfrak{S}_l}{V})(\rho)}}d\,(\taskst{g_i}{e_i})$ is the maximal leaf for the whole scheme.
   
   		\begin{enumerate}
   		\item Suppose $\smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_1}{V})(\rho)}} d\,(\taskst{g_i}{e_i}) \le \smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_2}{V})(\rho)}} d\,(\taskst{g_i}{e_i})$.
   		
   		Then we can absorb the summand $(\mathcal{D}(\schemewithvset{\mathfrak{S}_1}{V})(\rho) - \smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_1}{V})(\rho)}} d\,(\taskst{g_i}{e_i}))$ under $\Theta$ by the larger summand $\mathcal{D}(\schemewithvset{\mathfrak{S}_1}{V})(\rho)$ (which came from $\min$) by \lemmaword~\ref{lem:theta_absorb}. We get the following approximation which is exactly what we need:
   		
   		\[ \begin{array}{lcl}
		t\,(\taskst{\disjgoal{g_1 \rho}{g_2 \rho}}{e_{init}}) &=& \mathcal{T}(\schemewithvset{\mathfrak{S}_1}{V})(\rho) + \mathcal{T}(\schemewithvset{\mathfrak{S}_2}{V})(\rho) + \\
		& & \Theta\,(\mathcal{D}(\schemewithvset{\mathfrak{S}_1}{V})(\rho) + \\
		& & + (\mathcal{D}(\schemewithvset{\mathfrak{S}_2}{V})(\rho) - \smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_2}{V})(\rho)}} d\,(\taskst{g_i}{e_i})) + 1) \\
		\end{array} \]
		
		\item Suppose $\smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_1}{V})(\rho)}} d\,(\taskst{g_i}{e_i}) > \smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_2}{V})(\rho)}} d\,(\taskst{g_i}{e_i})$.
		
		Then we establish the lower and the upper bounds separately.
		
			\begin{enumerate}
   			\item For the lower bound we again first absorb the summand $(\mathcal{D}(\schemewithvset{\mathfrak{S}_1}{V})(\rho) - \smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_1}{V})(\rho)}} d\,(\taskst{g_i}{e_i}))$ by \lemmaword~\ref{lem:theta_absorb} to get the following.

			\[ \begin{array}{lcl}
			t\,(\taskst{\disjgoal{g_1 \rho}{g_2 \rho}}{e_{init}}) &\ge& \mathcal{T}(\schemewithvset{\mathfrak{S}_1}{V})(\rho) + \mathcal{T}(\schemewithvset{\mathfrak{S}_2}{V})(\rho) + \\
			& & C_1 \cdot (\mathcal{D}(\schemewithvset{\mathfrak{S}_1}{V})(\rho) + \\
			& & + (\mathcal{D}(\schemewithvset{\mathfrak{S}_2}{V})(\rho) - \smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_2}{V})(\rho)}} d\,(\taskst{g_i}{e_i})) + 1) \\
			\end{array} \]		
		
			Then replace $(-\smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_2}{V})(\rho)}} d\,(\taskst{g_i}{e_i}))$ \\ by $(-\smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_1}{V})(\rho)}} d\,(\taskst{g_i}{e_i}))$ which is smaller by assumption.
		
			\item For the upper bound we first replace $\mathcal{D}(\schemewithvset{\mathfrak{S}_1}{V})(\rho)$ that came form $\min$ by $\mathcal{D}(\schemewithvset{\mathfrak{S}_2}{V})(\rho)$ which is larger by the assumption and then absorb the summand $(\mathcal{D}(\schemewithvset{\mathfrak{S}_2}{V})(\rho) - \smashoperator{\maxd\limits_{\taskst{g_i}{e_i} \in \mathcal{L}(\schemewithvset{\mathfrak{S}_2}{V})(\rho)}} d\,(\taskst{g_i}{e_i}))$ by it.
			
			\end{enumerate}		
   		\end{enumerate}
	\end{enumerate}

\item Now let's prove the statement of the theorem for $g \in C_{nf}$.

Let $g = { \conjgoal{(\conjgoal{(\conjgoal{g_1}{g_2})}{\dots})}{g_k} }$ with $g_i \in B_{nf}$.

First, notice that the state $\taskst{g}{e_{init}}$ is transformed into the state \\ ${ ((\taskst{g_1}{\mkenv{\varepsilon}{n_{init}(g)}} \otimes g_2) \otimes \dots) \otimes g_k }$ after $(k - 1)$ steps of turning conjunctions into $\otimes$-states. All states during this steps except the resulting one add $(k - 1)$ to the value $d\,(\taskst{g}{e_{init}})$ and $\dfrac{(k - 1)(k - 2)}{2}$ to the value $t\,(\taskst{g}{e_{init}})$, we can hide this constants under $\Theta$ by \lemmaword~\ref{lem:theta_absorb}. \lemmaword~\ref{lem:times_gen_measure_approximations} gives us the approximations of the measures for the state ${ ((\taskst{g_1}{\mkenv{\varepsilon}{n_{init}(g)}} \otimes g_2) \otimes \dots) \otimes g_k }$. To put it in a convenient form we will use the following definitions.

\[ \begin{array}{lcl}
D\,(s, \epsilon) & = & d\,(s) \\
D\,(s, g : \Gamma) & = & d\,(s) + \smashoperator{\sum\limits_{a \in \tra{s}}} D\,(\taskst{g}{a}, \Gamma) \\
\\
T\,(s, \epsilon) & = & t\,(s) \\
T\,(s, g : \Gamma) & = & t\,(s) + \smashoperator{\sum\limits_{a \in \tra{s}}} T\,(\taskst{g}{a}, \Gamma) \\
\\
L\,(s, \epsilon) & = & \{ s \} \\
L\,(s, g : \Gamma) & = & \smashoperator{\bigcup\limits_{a \in \tra{s}}} T\,(\taskst{g}{a}, \Gamma) \\
\end{array}
\]

Now,  \lemmaword~\ref{lem:times_gen_measure_approximations} gives us the following approximations if we denote ${ g_2 \rho : \dots g_k \rho}$ by $\Gamma$.

\[ \begin{array}{lcl}
d\,(\taskst{g \rho}{e_{init}}) &=& D\,(\taskst{g_1 \rho}{\mkenv{\varepsilon}{n_{init}(g)}}, \Gamma) + \Theta\,(1) \\
\\
t\,(\taskst{g \rho}{e_{init}}) &=& T\,(\taskst{g_1 \rho}{\mkenv{\varepsilon}{n_{init}(g)}}, \Gamma) + \\ 
& & \Theta\,(D\,(\taskst{g_1 \rho}{\mkenv{\varepsilon}{n_{init}(g)}}, \Gamma) - \smashoperator{\maxd\limits_{s \in L\,(\taskst{g_1 \rho}{\mkenv{\varepsilon}{n_{init}(g)}}, \Gamma)}} d\,(s) + 1) \\
\end{array} \]

It's the approximation in the form required in the statement of the theorem. What remains to be proven are the following equalities:

\[ \begin{array}{lcl}
D\,(\taskst{g_1 \rho}{\mkenv{\varepsilon}{n_{init}(g)}}, \Gamma) &=& \mathcal{D}(\schemewithvset{\mathfrak{S}}{V})(\rho) \\
T\,(\taskst{g_1 \rho}{\mkenv{\varepsilon}{n_{init}(g)}}, \Gamma) &=& \mathcal{T}(\schemewithvset{\mathfrak{S}}{V})(\rho) \\
\{ d\,(s) \mid s \in L\,(\taskst{g_1 \rho}{\mkenv{\varepsilon}{n_{init}(g)}}, \Gamma)\} &=& \{ d\,(s) \mid s \in \mathcal{L}(\schemewithvset{\mathfrak{S}}{V})(\rho) \} \\
\end{array} \]
	
We can prove them by induction, but first we need to generalize the statement. Let $g$ be a goal from $B_{nf}$ and $\Gamma = { g_1 : \dots : g_m : \epsilon }$~--- a sequence of goals from $B_{nf}$, $\sigma$ be a substitution, $n$ be a fresh variable counter such that the state ${ (((\taskst{g}{\mkenv{\sigma}{n}} \otimes g_1) \otimes \dots) \otimes g_m) }$ is well-formed, and $V$ be a subset of variables $\{ \alpha_1, \dots, \alpha_n \}$. Then if \[ \schemetrans{g}{\Gamma}{\sigma}{n}{V}{\schemewithvset{\mathfrak{S}}{V}} \] then the following equalities hold for any $\rho \colon V \to \mathcal{T}_{\emptyset}$.

\[ \begin{array}{lcl}
D\,(\taskst{g}{\mkenv{\sigma \rho}{n}}, \Gamma) &=& \mathcal{D}(\schemewithvset{\mathfrak{S}}{V})(\rho) \\
T\,(\taskst{g}{\mkenv{\sigma \rho}{n}}, \Gamma) &=& \mathcal{T}(\schemewithvset{\mathfrak{S}}{V})(\rho) \\
\{ d\,(s) \mid s \in L\,(\taskst{g}{\mkenv{\sigma \rho}{n}}, \Gamma)\} &=& \{ d\,(s) \mid s \in \mathcal{L}(\schemewithvset{\mathfrak{S}}{V})(\rho) \} \\
\end{array} \]

(to get from this generalization to the equations above we should take $\sigma = \varepsilon$ and apply \lemmaword~\ref{lem:measures_changing_env} to move $\rho$ from environment to the goal).

We prove the generalized statement by the induction on $\Gamma$ and considering cases when $g$ is an equality or a relational call. The reasoning is exactly the same for all three notions $D\,(\cdot)$, $T\,(\cdot)$ and $L\,(\cdot)$, so we demonstrate only the proof of the equality between $D\,(\cdot)$ and $\mathcal{D}(\cdot)(\cdot)$.

	\begin{enumerate}

	\item Let $\Gamma = \epsilon$ and $g = (\unigoal{t_1}{t_2})$.
	
	In this case we have \[ d\,(\taskst{\unigoal{t_1}{t_2}}{\mkenv{\sigma \rho}{n}}) = d\,(\taskst{\unigoal{t_1 \sigma \rho}{t_2 \sigma \rho}}{e_{init}}) = 1 \]
	
	\item Let $\Gamma = \epsilon$ and $g = (\invokegoal{R^k}{t_1}{t_k})$.
	
	In this case we have \[ d\,(\taskst{\invokegoal{R^k}{t_1}{t_k}}{\mkenv{\sigma \rho}{n}}) = d\,(\taskst{\invokegoal{R^k}{t_1 \sigma \rho}{t_k \sigma \rho}}{e_{init}}) \]
	
	Which is true by \lemmaword~\ref{lem:measures_changing_env}.
	
	\item Let $\Gamma = g' : \Gamma'$ and $g = (\unigoal{t_1}{t_2})$.
	
	\begin{enumerate}
	
	    \item If the terms $t_1 \sigma$ and $t_2 \sigma$ are non-unifiable, we have \[ d\,(\taskst{\unigoal{t_1}{t_2}}{\mkenv{\sigma \rho}{n}}) + \smashoperator{\sum\limits_{mgu\,(t_1 \sigma \rho, t_2 \sigma \rho) = \delta'}} D\,(\taskst{g'}{\mkenv{\sigma \rho \delta'}{n}}, \Gamma') = 1 \]
	    
	    And it is obviously true because the sum is empty since the more specific terms there are non-unifiable also.
	
	    \item If they are unifiable, we have \[ d\,(\taskst{\unigoal{t_1}{t_2}}{\mkenv{\sigma \rho}{n}}) + \smashoperator{\sum\limits_{mgu\,(t_1 \sigma \rho, t_2 \sigma \rho) = \delta'}} D\,(\taskst{g'}{\mkenv{\sigma \rho \delta'}{n}}, \Gamma') = \]
	
	\[ = 1 +
      \smashoperator{\sum\limits_{\substack{ \rho' \colon U \to \grterms \\
                                      \rho' \succ \rho \\
                                      \forall (y, t) \in Cs, \rho'(y) = t \rho'  }}}
           \mathcal{D}(\schemewithvset{\mathfrak{S}}{U})(\rho')  \]
           
    		where
    
    \[ \begin{array}{lcl}
    \delta & = & mgu\,(t_1 \sigma, t_2 \sigma) \\
    U & = & \upd{V}{\delta} \\
    Cs & = & \constr{\delta}{U} \\
	\end{array} \]
	
			The left summands are obviously equal. The rest is basically covered by \lemmaword~\ref{lem:symbolic_unification_soundness}. By this lemma there exists a most general unifier $\delta'$ iff the required $\rho'$ exists. So both sums are non-empty under the same conditions and have at most one summand (since $\rho'$ is unique), and if it is the case these summands are equal by \lemmaword~\ref{lem:symbolic_unification_soundness}, the inductive hypothesis and the fact that the value $D$ is stable w.r.t. renaming of variables (it is a generalization of \lemmaword~\ref{lem:measures_changing_env} that follows simply from \lemmaword~\ref{lem:gen_measures_changing_env}):
	
\[ \begin{array}{l}
D\,(\taskst{g'}{\mkenv{\sigma \rho \delta'}{n}}, \Gamma') \stackrel{\text{\lemmaword~\ref{lem:symbolic_unification_soundness}}}{=} D\,(\taskst{g'}{\mkenv{\sigma \delta \rho' \tau}{n}}, \Gamma') = \\
= D\,(\taskst{g'}{\mkenv{\sigma \delta \rho'}{n}}, \Gamma') \stackrel{\text{ind.hyp.}}{=} \mathcal{D}(\schemewithvset{\mathfrak{S}}{U})(\rho')
\end{array} \] 

	\end{enumerate}
	
	\item Let $\Gamma = g' : \Gamma'$ and $g = (\invokegoal{R^k}{t_1}{t_k})$.
	
	In this case we have \[ d\,(\taskst{\invokegoal{R^k}{t_1}{t_k}}{\mkenv{\sigma\rho}{n}}) + \smashoperator{\sum\limits_{a \in \tra{\taskst{\invokegoal{R^k}{t_1}{t_k}}{\mkenv{\sigma\rho}{n}}}}} D\,(\taskst{g'}{a}, \Gamma') = \]
	
	\[ = d\,(\taskst{\invokegoal{R^k}{t_1 \sigma \rho}{t_k \sigma \rho}}{e_{init}}) +
      \smashoperator{\sum\limits_{\substack{ \rho' \colon U \to \grterms \\
                                      \rho' \succ \rho \\
                                      (t_1 \sigma \rho', \dots, t_k \sigma \rho') \in \sembr{R^k}  }}}
           \mathcal{D}(\schemewithvset{\mathfrak{S}}{U})(\rho')  \]
           
    where
    
    \[ \begin{array}{lcl}
    U & = &  V \cup \bigcup_{i} FV\,(t_i \sigma) \\
    \end{array} \]
    
    The left summands are equal by \lemmaword~\ref{lem:measures_changing_env}.
    
    Each $a \in \tra{\taskst{\invokegoal{R^k}{t_1}{t_k}}{\mkenv{\sigma\rho}{n}}}$ has the form $(\sigma \rho \delta, n')$ for some $\delta$ and some $n' > n$ by \lemmaword~\ref{lem:gen_measures_changing_env}. All free variables of terms $t_i$ are mapped into ground terms in each delta, because the relational call is grounding.
    
    There is a bijection between the set of answers under the sum on the lhs and a set of suitable $\rho'$ at the rhs: all ground values for the free variables that are consistent with the denotational semantics are present in some answer (because of completeness of the operational semantics w.r.t. to the denotational one) and in exactly one (because the call is answer-unique).
    
    Now, we need to show that if we take any answer $(\sigma \rho \delta, n')$ and $\rho'$ that corresponds to it by the described bijection then the values for them under the sums are equal. First, we need to replace $D\,(\taskst{g'}{(\sigma \rho \delta, n')}, \Gamma')$ by $D\,(\taskst{g'}{(\sigma \rho \delta\restriction_U, n)}, \Gamma')$, we can do it because all variables from $\Dom\,(\delta) \setminus U$ have indices greater or equal than $n$ (by \lemmaword~\ref{lem:update_substitutions_FV}) and therefore these variables are not free variables of goals from $(g' : \Gamma')$, so the values of $d$ on this goals will be the same for the restricted substitution (it follows simply from \lemmaword~\ref{lem:gen_measures_changing_env}). After this replacement we can directly apply the inductive hypothesis.
    \qed
	
	\end{enumerate}


\end{enumerate}
\end{proof}

